this.ckan.module("resource-upload-field",function(c,a,b){return{options:{form:{method:"POST",file:"file",params:[]},i18n:{label:a("Upload a file"),errorTitle:a("An Error Occurred"),uploadSuccess:a("Resource uploaded"),uploadError:a("Unable to upload file"),authError:a("Unable to authenticate upload"),metadataError:a("Unable to get data for uploaded file"),uploadingWarning:a("You are uploading a file. Are you sure you want to navigate away and stop this upload?")},template:['<span class="resource-upload-field">','<i class="ckan-icon ckan-icon-link-plugin"></i>','<input  onclick="ocultarDatos(false);" type="file" />','<input id="field-resource-type-upload" type="radio" name="resource_type" value="file.upload" />','<label class="radio inline" for="field-resource-type-upload"></label>',"</span>"].join("\n")},initialize:function(){c.proxyAll(this,/_on/);this.upload=c(this.options.template);this.setupFileUpload();this.el.append(this.upload);c(window).on("beforeunload",this._onWindowUpload)},setupFileUpload:function(){var d=this.options;this.upload.find("label").text(this.i18n("label"));this.upload.find("input[type=file]").fileupload({type:d.form.method,paramName:d.form.file,forceIframeTransport:true,replaceFileInput:true,autoUpload:false,add:this._onUploadAdd,send:this._onUploadSend,done:this._onUploadDone,fail:this._onUploadFail,always:this._onUploadComplete})},loading:function(d){this.upload.toggleClass("loading",d)},authenticate:function(d,f){f.key=d;var e=this.sandbox.client.getStorageAuth(d);var g=c.proxy(this._onAuthSuccess,this,f);return e.then(g,this._onAuthError)},lookupMetadata:function(d,f){var e=this.sandbox.client.getStorageMetadata(d);var g=c.proxy(this._onMetadataSuccess,this,f);return e.then(g,this._onMetadataError)},notify:function(e,d){var f=this.i18n("errorTitle");this.sandbox.notify(f,e,d)},generateKey:function(d){var e=d.split(".");var h=c.url.slugify(e.pop());d=c.url.slugify(e.join("."))+"."+h;var g=document.getElementById("organizacionDataset");var f=g.value;if(f){d=f+"/"+d}else{d="general/"+d}return d},uploading:function(d){var e=d?"on":"off";c(window)[e]("beforeunload",this._onWindowBeforeUnload)},_onUploadAdd:function(e,f){this.uploading(true);if(f.files&&f.files.length){var d=this.generateKey(f.files[0].name);this.authenticate(d,f)}},_onUploadFail:function(){this.sandbox.notify(this.i18n("uploadError"))},_onUploadSend:function(){this.loading()},_onUploadDone:function(e,f){var d=f.result;if(d&&!(c.isPlainObject(d)&&d.error)){this.lookupMetadata(f.key,f)}else{this._onUploadFail(e,f)}},_onUploadComplete:function(){this.loading(false);this.uploading(false)},_onAuthSuccess:function(e,d){e.url=d.action;e.formData=this.options.form.params.concat(d.fields);e.submit()},_onAuthError:function(d,e){this.sandbox.notify(this.i18n("authError"));this._onUploadComplete()},_onMetadataSuccess:function(f,d){var e=this.sandbox.client.convertStorageMetadataToResource(d);this.sandbox.notify(this.i18n("uploadSuccess"),"","success");this.sandbox.publish("resource:uploaded",e)},_onMetadataError:function(){this.sandbox.notify(this.i18n("metadataError"));this._onUploadComplete()},_onWindowBeforeUnload:function(e){var d=this.i18n("uploadingWarning");if(e.originalEvent.returnValue){e.originalEvent.returnValue=d}return d}}});