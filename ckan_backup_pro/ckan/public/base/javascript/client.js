(function(a,b){function c(d){this.endpoint=d&&d.endpoint||"";b.proxyAll(this,/parse/)}b.extend(c.prototype,{url:function(d){if(!(/^https?:\/\//i).test(d)){d=this.endpoint+"/"+encodeURI(d).replace(/^\//,"")}return d},call:function(h,j,i,g,f){var e=this.url("/api/action/"+j);var f=(f=="undefined")?function(){}:f;var d={contentType:"application/json",url:e,dataType:"json",processData:false,success:g,error:f};if(h=="POST"){d.type="POST";d.data=JSON.stringify(i)}else{d.type="GET";d.url+=i}b.ajax(d)},getTemplate:function(d,h,g,f){var e=this.url("/api/1/util/snippet/"+encodeURIComponent(d));if(typeof h==="function"){f=g;g=h;h={}}return b.get(e,h||{}).then(g,f)},getLocaleData:function(d,g,f){var e=this.url("/api/i18n/"+(d||""));return b.getJSON(e).then(g,f)},getCompletions:function(f,e,i,d){if(typeof e==="function"){d=i;i=e;e={}}var g=e&&e.format||this.parseCompletions;var h=b.ajax({url:this.url(f)});return h.pipe(g).promise(h).then(i,d)},parseCompletions:function(g,f){if(typeof g==="string"){return this.parsePackageCompletions(g,f)}var h={};var e=b.isArray(g)?g:g.ResultSet&&g.ResultSet.Result||{};var d=b.map(e,function(l){var k=typeof f.key!="undefined"?l[f.key]:false;var j=typeof f.label!="undefined"?l[f.label]:false;l=typeof l==="string"?l:l.name||l.Name||l.Format||"";l=b.trim(l);k=k?k:l;j=j?j:l;var m=l.toLowerCase();var i=f&&f.objects===true;if(m&&!h[m]){h[m]=1;return i?{id:k,text:j}:l}return null});d=b.grep(d,function(i){return i!==null});return d},parseCompletionsForPlugin:function(d){return{results:this.parseCompletions(d,{objects:true})}},parsePackageCompletions:function(f,e){var g=b.trim(f).split("\n");var d=[];return b.map(g,function(h){var i=h.split("|");var k=b.trim(i.pop()||"");var j=b.trim(i.join("|")||"");return e&&e.objects===true?{id:k,text:j}:k})},getStorageAuth:function(e,f,d){if(!e){throw new Error("Client#getStorageAuth() must be called with a key")}return b.ajax({url:this.url("/api/storage/auth/form/"+e),success:f,error:d})},getStorageMetadata:function(e,f,d){if(!e){throw new Error("Client#getStorageMetadata() must be called with a key")}return b.ajax({url:this.url("/api/storage/metadata/"+e),success:f,error:d})},convertStorageMetadataToResource:function(j){var f=new Date(this.normalizeTimestamp(j._last_modified));var k=new Date(this.normalizeTimestamp(j._creation_date));var h=b.date.toCKANString(k);var g=b.date.toCKANString(f);var d=j["filename-original"]||j.key;var i=j._format||d.split(".").pop();var e=j._location;if(e.indexOf("://")===-1){e=a.url(e)}return{url:e,key:j.key,name:d,size:j._content_length,created:h,last_modified:g,format:i,mimetype:j._format||null,resource_type:"file.upload",owner:j["uploaded-by"],hash:j._checksum,cache_url:j._location,cache_url_updated:g}},normalizeTimestamp:function(d){var e=/[+\-]\d{4}|Z/;if(!e.test(d)){d+="Z"}return d}});a.sandbox.setup(function(d){d.client=new c({endpoint:a.SITE_ROOT})});a.Client=c})(this.ckan,this.jQuery);