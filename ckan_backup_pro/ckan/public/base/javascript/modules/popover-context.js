window.popover_context={dict:{user:{},dataset:{},group:{}},render:{user:{},dataset:{},group:{}}};this.ckan.module("popover-context",function(b,a){return{options:{id:null,loading:false,error:false,authed:false,throbber:'<img src="{SITE_ROOT}/base/images/loading-spinner.gif">',i18n:{loading:a("Loading...")}},initialize:function(){if(this.options.id!=true&&this.options.id!=null){b.proxyAll(this,/_on/);if(b(".account").hasClass("authed")){this.options.authed=b(".account").data("me")}this.el.popover({animation:false,html:true,content:this.options.throbber.replace("{SITE_ROOT}",ckan.SITE_ROOT)+this.i18n("loading"),placement:"bottom"});this.el.on("mouseover",this._onMouseOver);b(document).on("mouseup",this._onDocumentMouseUp);this.sandbox.subscribe("follow-follow-"+this.options.id,this._onHandleFollow);this.sandbox.subscribe("follow-unfollow-"+this.options.id,this._onHandleFollow)}},_onDocumentMouseUp:function(c){var d=this.el.data("popover");if(typeof d.$tip!="undefined"){if(d.$tip.has(c.target).length===0){this.el.popover("hide")}}},loadingHelper:function(d){this.options.loading=d;var c=this.el.data("popover");if(typeof c.$tip!="undefined"){if(d){c.$tip.addClass("popover-context-loading")}else{c.$tip.removeClass("popover-context-loading")}}},_onMouseOver:function(){b('[data-module="popover-context"]').popover("hide");this.el.popover("show");this.getData()},getData:function(){if(!this.options.loading){this.loadingHelper(true);var f=this.options.id;var d=this.options.type;if(typeof window.popover_context.dict[d][f]=="undefined"){var c=this.sandbox.client;var e=d+"_show";if(d=="dataset"){e="package_show"}c.call("GET",e,"?id="+f,this._onHandleData,this._onHandleError)}else{this._onHandleData(window.popover_context.dict[d][f])}}},_onHandleError:function(c){b('[data-module="popover-context"][data-module-type="'+this.options.type+'"][data-module-id="'+this.options.id+'"]').popover("destroy")},_onHandleData:function(d){if(d.success){var g=this.options.id;var e=this.options.type;var c=this.sandbox.client;window.popover_context.dict[e][g]=d;if(typeof window.popover_context.render[e][g]=="undefined"){var f=this.sanitiseParams(d.result);c.getTemplate("popover_context_"+e+".html",f,this._onRenderPopover)}else{this._onRenderPopover(window.popover_context.render[e][g])}}},sanitiseParams:function(c){var d=this.options.type;var e={};if(d=="user"){e.id=c.id;e.name=c.name;e.about=c.about;e.display_name=c.display_name;e.num_followers=c.num_followers;e.number_administered_packages=c.number_administered_packages;e.number_of_edits=c.number_of_edits;e.is_me=(c.id==this.options.authed)}else{if(d=="dataset"){e.id=c.id;e.title=c.title;e.name=c.name;e.notes=c.notes;e.num_resources=c.num_resources;e.num_tags=c.num_tags}else{if(d=="group"){e.id=c.id;e.title=c.title;e.name=c.name;e.description=c.description;e.package_count=c.package_count;e.num_followers=c.num_followers}}}return e},_onRenderPopover:function(c){var j=this.options.id;var d=this.options.type;var i=window.popover_context.dict[d][j].result;var g=this.el.data("popover");if(typeof g.$tip!="undefined"){var f=g.$tip;var h=(d=="user")?i.display_name:i.title;b(".popover-title",f).html('<a href="javascript:;" class="popover-close">&times;</a>'+h);b(".popover-content",f).html(c);b(".popover-close",f).on("click",this._onClickPopoverClose);var e=this.getFollowButton();if(e){ckan.module.initializeElement(e[0])}this.loadingHelper(false)}window.popover_context.render[d][j]=c},_onClickPopoverClose:function(){this.el.popover("hide")},getFollowButton:function(){var d=this.el.data("popover");if(typeof d.$tip!="undefined"){var c=b('[data-module="follow"]',d.$tip);if(c.length>0){return c}}return false},_onHandleFollow:function(){delete window.popover_context.render[this.options.type][this.options.id]}}});