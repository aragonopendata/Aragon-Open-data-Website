var CKAN=CKAN||{};CKAN.View=CKAN.View||{};CKAN.Model=CKAN.Model||{};CKAN.Utils=CKAN.Utils||{};(function(a){a(document).ready(function(){CKAN.Utils.relatedSetup(a("#form-add-related"));CKAN.Utils.setupUserAutocomplete(a("input.autocomplete-user"));CKAN.Utils.setupOrganizationUserAutocomplete(a("input.autocomplete-organization-user"));CKAN.Utils.setupGroupAutocomplete(a("input.autocomplete-group"));CKAN.Utils.setupPackageAutocomplete(a("input.autocomplete-dataset"));CKAN.Utils.setupTagAutocomplete(a("input.autocomplete-tag"));a("input.autocomplete-format").live("keyup",function(){CKAN.Utils.setupFormatAutocomplete(a(this))});CKAN.Utils.setupMarkdownEditor(a(".markdown-editor"));a(".collapse").collapse({toggle:false});a("input.href-action").click(function(q){q.preventDefault();window.location=(a(q.target).attr("action"))});var e=a("body.group.read").length>0;if(e){CKAN.Utils.setupNotesExtract()}var g=a("body.package.read").length>0;if(g){CKAN.Utils.setupNotesExtract()}var n=false;if(n){CKAN.DataPreview.loadPreviewDialog(preload_resource)}var m=false;if(m){CKAN.DataPreview.loadEmbeddedPreview(preload_resource,reclineState)}if(a(document.body).hasClass("search")){(function d(){var s=a("#dataset-search"),q=s.find("[name=q]"),r=s.find("[type=submit]"),t=parseFloat(r.css("margin-left"));a.each(["padding-left","padding-right","border-left-width","border-right-width"],function(u,v){t+=parseFloat(q.css(v))||0});q.width(s.outerWidth()-r.outerWidth()-t)})()}var l=a("body.package.new").length>0;if(l){var f=new CKAN.View.UrlEditor({slugType:"package"});a("#save").val(CKAN.Strings.addDataset);a("#title").focus()}var c=a("body.group.new").length>0;if(c){var f=new CKAN.View.UrlEditor({slugType:"group"});a("#save").val(CKAN.Strings.addGroup);a("#title").focus()}var k=a("body.package.edit").length>0;if(k){CKAN.Utils.warnOnFormChanges(a("form#dataset-edit"));var f=new CKAN.View.UrlEditor({slugType:"package"});CKAN.Utils.setupDatasetDeleteButton()}var j=a("body.package.editresources").length>0;if(l||j){var b=a.inArray("storage",CKAN.plugins)>=0;if(b){a("li.js-upload-file").show()}var p=Backbone.Collection.extend({model:CKAN.Model.Resource});var o=new CKAN.View.ResourceEditor({collection:new p(resources_json),el:a("form#dataset-edit")});o.render();a(".drag-drop-list").sortable({distance:10});a(".drag-drop-list").disableSelection()}var h=a("body.group.edit").length>0;if(h){var f=new CKAN.View.UrlEditor({slugType:"group"})}if(window.openid&&openid.signin){openid._signin=openid.signin;openid.signin=function(q){a.get(CKAN.SITE_URL+"/user/set_lang/"+CKAN.LANG,function(){openid._signin(q)})}}if(a("#login").length){a("#login").submit(function(){a.ajax(CKAN.SITE_URL+"/user/set_lang/"+CKAN.LANG,{async:false})})}})}(jQuery));jQuery.fn.truncate=function(a,b){return this.each(function(){var d=jQuery(this),c=d.hasClass("truncated"),f,g,h,e;if(c){d.html(d.data("truncate:"+(a==="expand"?"original":"truncated")));return}f=d.text();g=a||d.data("truncate")||30;h=f.slice(0,g);e=jQuery('<a href="#" />').text(b||"Â»");if(f.length<g){return}while((/\S/).test(h[h.length-1])){h=h.slice(0,h.length-1)}d.html(jQuery.trim(h));e.appendTo(d.append(" "));e.click(function(j){j.preventDefault();d.html(f)});d.addClass("truncated");d.data("truncate:original",f);d.data("truncate:truncated",d.html())})};CKAN.Model.Resource=Backbone.Model.extend({constructor:function Resource(){Backbone.Model.prototype.constructor.apply(this,arguments)},toTemplateJSON:function(){var a=Backbone.Model.prototype.toJSON.apply(this,arguments);a.displaytitle=a.description?a.description:"No description ...";return a}});CKAN.View.UrlEditor=Backbone.View.extend({initialize:function(){_.bindAll(this,"titleToSlug","titleChanged","urlChanged","checkSlugIsValid","apiCallback");var a=this;this.updateTimer=null;this.titleInput=$(".js-title");this.urlInput=$(".js-url-input");this.validMsg=$(".js-url-is-valid");this.lengthMsg=$(".url-is-long");this.lastTitle="";this.disableTitleChanged=false;this.regexToHyphen=[new RegExp("[ .:/_]","g"),new RegExp("[^a-zA-Z0-9-_]","g"),new RegExp("-+","g")];this.regexToDelete=[new RegExp("^-*","g"),new RegExp("-*$","g")];if(!this.options.apiUrl){this.options.apiUrl=CKAN.SITE_URL+"/api/2/util/is_slug_valid"}if(!this.options.MAX_SLUG_LENGTH){this.options.MAX_SLUG_LENGTH=90}this.originalUrl=this.urlInput.val();CKAN.Utils.bindInputChanges(this.titleInput,this.titleChanged);CKAN.Utils.bindInputChanges(this.urlInput,this.urlChanged);function b(){a.disableTitleChanged=true}this.urlInput.keyup(b);this.urlInput.keydown(b);this.urlInput.keypress(b);this.urlChanged()},titleToSlug:function(b){var a=b;$.each(this.regexToHyphen,function(c,d){a=a.replace(d,"-")});$.each(this.regexToDelete,function(c,d){a=a.replace(d,"")});a=a.toLowerCase();if(a.length<this.options.MAX_SLUG_LENGTH){a=a.substring(0,this.options.MAX_SLUG_LENGTH)}return a},titleChanged:function(){if(this.disableTitleChanged){return}var a=this.titleInput.val();if(a==this.lastTitle){return}this.lastTitle=a;slug=this.titleToSlug(a);this.urlInput.val(slug);this.urlInput.change()},urlChanged:function(){var b=this.urlInput.val();if(this.updateTimer){clearTimeout(this.updateTimer)}if(b.length<2){this.validMsg.html('<span style="font-weight: bold; color: #444;">'+CKAN.Strings.urlIsTooShort+"</span>")}else{if(b==this.originalUrl){this.validMsg.html('<span style="font-weight: bold; color: #000;">'+CKAN.Strings.urlIsUnchanged+"</span>")}else{this.validMsg.html('<span style="color: #777;">'+CKAN.Strings.checking+"</span>");var a=this;this.updateTimer=setTimeout(function(){a.checkSlugIsValid(b)},200)}}if(b.length>20){this.lengthMsg.show()}else{this.lengthMsg.hide()}},checkSlugIsValid:function(a){$.ajax({url:this.options.apiUrl,data:"type="+this.options.slugType+"&slug="+a,dataType:"jsonp",type:"get",jsonpCallback:"callback",success:this.apiCallback})},apiCallback:function(a){if(a.valid){this.validMsg.html('<span style="font-weight: bold; color: #0c0">'+CKAN.Strings.urlIsAvailable+"</span>")}else{this.validMsg.html('<span style="font-weight: bold; color: #c00">'+CKAN.Strings.urlIsNotAvailable+"</span>")}}});CKAN.View.ResourceEditor=Backbone.View.extend({initialize:function(){_.bindAll(this,"resourceAdded","resourceRemoved","sortStop","openFirstPanel","closePanel","openAddPanel");this.collection.bind("add",this.resourceAdded);this.collection.bind("remove",this.resourceRemoved);this.collection.each(this.resourceAdded);this.el.find(".resource-list-edit").bind("sortstop",this.sortStop);this.el.find(".js-resource-edit-barebones").remove();var b=CKAN.Utils.warnOnFormChanges(this.el);this.collection.bind("add",b);this.collection.bind("remove",b);this.el.find(".js-resource-add").click(this.openAddPanel);new CKAN.View.ResourceAddUrl({collection:this.collection,el:this.el.find(".js-add-url-form"),mode:"file"});new CKAN.View.ResourceAddUrlVista({collection:this.collection,el:this.el.find(".js-add-url-form-vista"),mode:"file"});new CKAN.View.ResourceAddUrl({collection:this.collection,el:this.el.find(".js-add-api-form"),mode:"api"});new CKAN.View.ResourceAddUpload({collection:this.collection,el:this.el.find(".js-add-upload-form")});this.el.find(".resource-panel-close").click(this.closePanel);if(typeof global_form_errors=="object"){if(global_form_errors.resources){var a=false;for(i in global_form_errors.resources){var d=global_form_errors.resources[i];if(CKAN.Utils.countObject(d)>0){var c=this.collection.at(i);c.view.setErrors(d);if(!a){c.view.openMyPanel();a=true}}}}}else{this.openFirstPanel()}},openFirstPanel:function(){if(this.collection.length>0){this.collection.at(0).view.openMyPanel()}else{this.openAddPanel()}},openAddPanel:function(c){if(c){c.preventDefault()}var a=this.el.find(".resource-panel");var b=this.el.find(".resource-list-add > li");this.el.find(".resource-list > li").removeClass("active");$(".resource-details").hide();this.el.find(".resource-details.resource-add").show();b.addClass("active");a.show()},closePanel:function(a){if(a){a.preventDefault()}this.el.find(".resource-list > li").removeClass("active");this.el.find(".resource-panel").hide()},sortStop:function(b,a){this.collection.each(function(e){var c=e.view.li.index();e.view.options.position=c;var d=e.view.table;$.each(d.find("input,textarea,select"),function(h,f){var g=$(f).attr("name");if(g){g=g.replace(/(resources__)\d+(.*)/,"$1"+c+"$2");$(f).attr("name",g)}})})},nextIndex:function(){var b=-1;var a=this.el.find(".resource-panel");a.find("input").each(function(c,d){var e=$(d).attr("name")||"";var g=e.split("__");if(g.length>1){var f=parseInt(g[1],10);b=Math.max(f,b)}});return b+1},resourceAdded:function(b){var a=this;b.view=new CKAN.View.Resource({position:this.nextIndex(),model:b,callback_deleteMe:function(){a.collection.remove(b)}});this.el.find(".resource-list-edit").append(b.view.li);this.el.find(".resource-panel").append(b.view.table);if(b.isNew()){b.view.openMyPanel()}},resourceRemoved:function(a){a.view.removeFromDom();delete a.view;this.openFirstPanel()}});CKAN.View.Resource=Backbone.View.extend({initialize:function(){this.el=$(this.el);_.bindAll(this,"updateName","updateIcon","name","askToDelete","openMyPanel","setErrors","setupDynamicExtras","addDynamicExtra");this.render()},render:function(){this.raw_resource=this.model.toTemplateJSON();var a={resource:this.raw_resource,num:this.options.position,resource_icon:"/images/icons/page_white.png",resourceTypeOptions:[["file",CKAN.Strings.dataFile],["vista",CKAN.Strings.vista],["api",CKAN.Strings.api],["visualization",CKAN.Strings.visualization],["image",CKAN.Strings.image],["metadata",CKAN.Strings.metadata],["documentation",CKAN.Strings.documentation],["code",CKAN.Strings.code],["example",CKAN.Strings.example]]};this.li=$($.tmpl(CKAN.Templates.resourceEntry,a));this.table=$($.tmpl(CKAN.Templates.resourceDetails,a));this.nameBox=this.table.find("input.js-resource-edit-name");this.descriptionBox=this.table.find("textarea.js-resource-edit-description");CKAN.Utils.bindInputChanges(this.nameBox,this.updateName);CKAN.Utils.bindInputChanges(this.descriptionBox,this.updateName);this.formatBox=this.table.find("input.js-resource-edit-format");CKAN.Utils.bindInputChanges(this.formatBox,this.updateIcon);this.li.find(".resource-open-my-panel").click(this.openMyPanel);this.table.find(".js-resource-edit-delete").click(this.askToDelete);CKAN.Utils.setupMarkdownEditor(this.table.find(".markdown-editor"));this.updateName();this.updateIcon();this.setupDynamicExtras();this.hasErrors=false},setErrors:function(a){if(CKAN.Utils.countObject(a)>0){this.hasErrors=true;this.errors=a;this.li.addClass("hasErrors");var b=$("<dl/>").addClass("errorList");$.each(a,function(e,d){var c="";var f=false;$.each(d,function(g,h){if(f){c+="<br/>"}c+=h;f=true});b.append($("<dt/>").html(e));b.append($("<dd/>").html(c))});this.table.find(".resource-errors").append(b).show()}},name:function(){var a=this.nameBox.val();if(!a){a=this.descriptionBox.val();if(!a){if(this.model.isNew()){a="<em>[new resource]</em>"}else{a="[no name] "+this.model.id}}}if(a.length>45){a=a.substring(0,45)+"..."}return a},updateName:function(){var a=this.li.find(".js-resource-edit-name");a.html("<span>"+this.name()+"</span>")},updateIcon:function(){var a=this;if(a.updateIconTimer){clearTimeout(a.updateIconTimer)}a.updateIconTimer=setTimeout(function(){$.getJSON(CKAN.SITE_URL+"/api/2/util/resource/format_icon?format="+encodeURIComponent(a.formatBox.val()),function(b){if(b&&b.icon&&b.format==a.formatBox.val()){a.li.find(".js-resource-icon").attr("src",b.icon);a.table.find(".js-resource-icon").attr("src",b.icon)}});delete a.updateIconTimer},100)},openMyPanel:function(b){if(b){b.preventDefault()}var a=this.table.parents(".resource-panel");a.find(".resource-details").hide();this.li.parents("fieldset#resources").find(".resource-list > li").removeClass("active");a.show();this.table.show();this.table.find(".js-resource-edit-name").focus();this.li.addClass("active")},askToDelete:function(a){a.preventDefault();var b=CKAN.Strings.deleteThisResourceQuestion.replace("%name%",this.name());if(confirm(b)){this.options.callback_deleteMe()}},setupDynamicExtras:function(){var a=this;$.each(this.raw_resource,function(b,c){if(a.reservedWord(b)){return}a.addDynamicExtra(b,c)});this.table.find(".add-resource-extra").click(function(b){b.preventDefault();a.addDynamicExtra("","")})},addDynamicExtra:function(f,g){var c=$($.tmpl(CKAN.Templates.resourceExtra,{num:this.options.position,key:f,value:g}));this.table.find(".dynamic-extras").append(c);var h=c.find(".extra-key");var a=c.find(".extra-value");var b=this;var e=function(){var l=h.val();var k=$.trim(l).replace(/\s+/g,"");if(b.reservedWord(k)){k=""}if(k.length){var j="resources__"+b.options.position+"__"+k;a.attr("name",j);a.removeClass("strikethrough")}else{a.removeAttr("name");a.addClass("strikethrough")}};var d=function(j){j.preventDefault();c.remove()};CKAN.Utils.bindInputChanges(c.find(".extra-key"),e);c.find(".remove-resource-extra").click(d);e()},reservedWord:function(a){return a=="cache_last_updated"||a=="cache_url"||a=="dataset"||a=="description"||a=="displaytitle"||a=="extras"||a=="format"||a=="hash"||a=="id"||a=="created"||a=="last_modified"||a=="mimetype"||a=="mimetype_inner"||a=="name"||a=="package_id"||a=="position"||a=="resource_group_id"||a=="resource_type"||a=="revision_id"||a=="revision_timestamp"||a=="size"||a=="size_extra"||a=="state"||a=="url"||a=="webstore_last_updated"||a=="webstore_url"},removeFromDom:function(){this.li.remove();this.table.remove()}});CKAN.View.ResourceAddUpload=Backbone.View.extend({tagName:"div",initialize:function(a){this.el=$(this.el);_.bindAll(this,"render","updateFormData","setMessage","uploadFile");$(CKAN.Templates.resourceUpload).appendTo(this.el);this.$messages=this.el.find(".alert");this.setupFileUpload()},events:{'click input[type="submit"]':"uploadFile"},setupFileUpload:function(){var a=this;this.el.find(".fileupload").fileupload({forceIframeTransport:true,replaceFileInput:false,autoUpload:false,fail:function(c,b){alert("Upload failed")},add:function(c,b){a.fileData=b;a.fileUploadData=b;a.key=a.makeUploadKey(b.files[0].name);a.updateFormData(a.key)},send:function(c,b){a.setMessage(CKAN.Strings.uploadingFile+' <img src="http://assets.okfn.org/images/icons/ajaxload-circle.gif" class="spinner" />')},done:function(c,b){a.onUploadComplete(a.key)}})},ISODateString:function(b){function a(c){return c<10?"0"+c:c}return b.getUTCFullYear()+"-"+a(b.getUTCMonth()+1)+"-"+a(b.getUTCDate())+"T"+a(b.getUTCHours())+":"+a(b.getUTCMinutes())+":"+a(b.getUTCSeconds())},makeUploadKey:function(d){var b=d.replace(/ /g,"-");var a=new Date();var c=this.ISODateString(a).replace(":","").replace(":","");return c+"/"+b},updateFormData:function(b){var a=this;a.setMessage(CKAN.Strings.checkingUploadPermissions+' <img src="http://assets.okfn.org/images/icons/ajaxload-circle.gif" class="spinner" />');a.el.find(".fileinfo").text(b);$.ajax({url:CKAN.SITE_URL+"/api/storage/auth/form/"+b,async:false,success:function(c){a.el.find("form").attr("action",c.action);_tmpl='<input type="hidden" name="${name}" value="${value}" />';var d=$(a.el.find("form div.hidden-inputs")[0]);$.each(c.fields,function(e,f){d.append($.tmpl(_tmpl,f))});a.hideMessage()},error:function(c,e,d){a.setMessage(CKAN.Strings.failedToGetCredentialsForUpload,"error");a.el.find('input[name="add-resource-upload"]').hide()}})},uploadFile:function(b){b.preventDefault();if(!this.fileData){alert("No file selected");return}var a=this.fileData.submit()},onUploadComplete:function(b){var a=this;$.ajax({url:CKAN.SITE_URL+"/api/storage/metadata/"+a.key,success:function(g){var e=g._label;if(e&&e.length>0&&e[0]==="/"){e=e.slice(1)}var h=new Date(g._last_modified);var f=a.ISODateString(h);var c=new CKAN.Model.Resource({});c.set({url:g._location,name:e,size:g._content_length,last_modified:f,format:g._format,mimetype:g._format,resource_type:"file.upload",owner:g["uploaded-by"],hash:g._checksum,cache_url:g._location,cache_url_updated:f},{error:function(j,d){var k="Filed uploaded OK but error adding resource: "+d+".";k+="You may need to create a resource directly. Uploaded file at: "+g._location;a.setMessage(k,"error")}});a.collection.add(c);a.setMessage("File uploaded OK and resource added","success")}})},setMessage:function(b,a){var a=a||"alert-info";this.$messages.removeClass("alert-info alert-success alert-error");this.$messages.addClass(a);this.$messages.show();this.$messages.html(b)},hideMessage:function(){this.$messages.hide("slow")}});CKAN.View.ResourceAddUrl=Backbone.View.extend({initialize:function(a){_.bindAll(this,"clickSubmit")},clickSubmit:function(f){f.preventDefault();var b=this;var a=new CKAN.Model.Resource({});this.el.find('input[name="add-resource-save"]').addClass("disabled");var d=this.el.find('input[name="add-resource-url"]').val();var c=$.inArray("qa",CKAN.plugins)>=0;if(c&&this.options.mode=="file"){$.ajax({url:CKAN.SITE_URL+"/qa/link_checker",context:a,data:{url:d},dataType:"json",error:function(){a.set({url:d,resource_type:"file"});b.collection.add(a);b.resetForm()},success:function(e){e=e[0];a.set({url:d,resource_type:"file",format:e.format,size:e.size,mimetype:e.mimetype,last_modified:e.last_modified,url_error:(e.url_errors||[""])[0]});b.collection.add(a);b.resetForm()}})}else{a.set({url:d,resource_type:this.options.mode});this.collection.add(a);this.resetForm()}},resetForm:function(){this.el.find('input[name="add-resource-save"]').removeClass("disabled");this.el.find('input[name="add-resource-url"]').val("")},events:{"click .btn":"clickSubmit"}});CKAN.View.ResourceAddUrlVista=Backbone.View.extend({initialize:function(a){_.bindAll(this,"clickSubmit")},clickSubmit:function(g){g.preventDefault();var m=this;var c=new CKAN.Model.Resource({});var h=new Date();var j=m.ISODateString(h);this.el.find('input[name="add-resource-save"]').addClass("disabled");var a="";var n=this.el.find('select[name="formato"]').val();var l=document.getElementById("vistas_value").value;try{var k=document.getElementById("filtro").value}catch(b){var k=""}if(n!="-1"){var f=$.inArray("qa",CKAN.plugins)>=0;$.ajax({url:CKAN.SITE_URL+"/guardarVista/"+l,async:false,data:"filtro="+k+";vista="+l+";formato="+n,dataType:"text",success:function(d){a=d},error:function(d,o,e){alert("A1-No se ha podido llevar a cabo la consulta")}});if(f&&this.options.mode=="file"){$.ajax({url:CKAN.SITE_URL+"/qa/link_checker",context:c,data:{url:a},dataType:"json",error:function(){c.set({url:a,resource_type:"vista",format:n});m.collection.add(c);m.resetForm()},success:function(d){d=d[0];c.set({url:a,resource_type:"vista",format:n,size:d.size,mimetype:d.mimetype,last_modified:d.last_modified,url_error:(d.url_errors||[""])[0]});m.collection.add(c);m.resetForm()}})}else{c.set({url:a,format:n,resource_type:"vista",last_modified:j});this.collection.add(c);this.resetForm()}}else{alert("Debe seleccionar un formato")}},ISODateString:function(b){function a(c){return c<10?"0"+c:c}return b.getUTCFullYear()+"-"+a(b.getUTCMonth()+1)+"-"+a(b.getUTCDate())+"T"+a(b.getUTCHours())+":"+a(b.getUTCMinutes())+":"+a(b.getUTCSeconds())},resetForm:function(){this.el.find('input[name="add-resource-save"]').removeClass("disabled");this.el.find('input[name="add-resource-url"]').val("");document.getElementById("filtro").value="";document.getElementById("botonesDiv").innerHTML="";document.getElementById("vistaDiv").innerHTML="";document.getElementById("guardadoDiv").innerHTML=""},events:{"click .btn-primary":"clickSubmit"}});CKAN.Utils=function(b,c){c.animateHeight=function(e,f){if(!f){f=350}e.show();var d=e.height();e.height(0);e.animate({height:d},f)};c.bindInputChanges=function(d,e){d.keyup(e);d.keydown(e);d.keypress(e);d.change(e)};c.setupDatasetDeleteButton=function(){var d=b("select.dataset-delete");d.attr("disabled","disabled");d.css({opacity:0.3});b("button.dataset-delete").click(function(f){d.removeAttr("disabled");d.fadeTo("fast",1);b(f.target).css({opacity:0});b(f.target).attr("disabled","disabled");return false})};c.setupPackageAutocomplete=function(d){d.autocomplete({minLength:0,source:function(f,g){var e="/dataset/autocomplete?q="+f.term;b.ajax({url:e,success:function(k){var j=[];var h=k.split("\n");b.each(h,function(l,o){var n=o.split("|");var m={label:n[0],value:n[1]};j.push(m)});g(j)}})},select:function(h,l){var m=b(this);m.val("");var e=m.attr("name");var g=/^(\S+)__(\d+)__(\S+)$/;var f=e.match(g);var k=f[1]+"__"+(parseInt(f[2],10)+1)+"__"+f[3];m.attr("name",k);m.attr("id",k);var j=b('<div class="ckan-dataset-to-add"><p></p></div>');j.append(b('<input type="hidden" />').attr("name",e).val(l.item.value));j.append('<i class="icon-plus-sign"></i> ');j.append(l.item.label);m.after(j);return false}})};c.setupTagAutocomplete=function(d){d.bind("keydown",function(e){if(e.keyCode===b.ui.keyCode.TAB&&b(this).data("autocomplete").menu.active){e.preventDefault()}}).autocomplete({minLength:1,source:function(g,h){var f=b.trim(g.term.split(",").pop());var e=CKAN.SITE_URL+"/api/2/util/tag/autocomplete?incomplete="+f;b.getJSON(e,function(k){var j=b.map(k.ResultSet.Result,function(m,l){return m.Name});h(b.ui.autocomplete.filter(j,f))})},focus:function(){return false},select:function(f,g){var e=this.value.split(",");e.pop();e.push(" "+g.item.value);e.push(" ");this.value=e.join(",");return false}})};c.setupFormatAutocomplete=function(d){d.autocomplete({minLength:1,source:function(f,g){var e=CKAN.SITE_URL+"/api/2/util/resource/format_autocomplete?incomplete="+f.term;b.getJSON(e,function(j){var h=b.map(j.ResultSet.Result,function(l,k){return l.Format});g(h)})}})};c.setupOrganizationUserAutocomplete=function(d){d.autocomplete({minLength:2,source:function(f,g){var e="/api/2/util/user/autocomplete?q="+f.term;b.getJSON(e,function(h){b.each(h,function(j,l){var k=l.name;if(l.fullname){k+=" ["+l.fullname+"]"}l.label=k;l.value=l.name});g(h)})},select:function(h,k){var m=b(this);m.val("");var l=m.parent("dd");var e=m.attr("name");var g=/^(\S+)__(\d+)__(\S+)$/;var f=e.match(g);var j=f[1]+"__"+(parseInt(f[2],10)+1)+"__"+f[3];m.attr("name",j);m.attr("id",j);l.before('<input type="hidden" name="'+e+'" value="'+k.item.value+'"><input type="hidden" name="'+e.replace("__name","__capacity")+'" value="editor"><dd>'+k.item.label+"</dd>");return false}})};c.setupUserAutocomplete=function(d){d.autocomplete({minLength:2,source:function(f,g){var e=CKAN.SITE_URL+"/api/2/util/user/autocomplete?q="+f.term;b.getJSON(e,function(h){b.each(h,function(j,l){var k=l.name;if(l.fullname){k+=" ["+l.fullname+"]"}l.label=k;l.value=l.name});g(h)})}})};c.relatedSetup=function(e){b("[rel=popover]").popover();function f(h){b('<div class="alert alert-error" />').html(h).hide().prependTo(e).fadeIn()}function g(j,k,h){return b.ajax({type:k,dataType:"json",contentType:"application/json",url:CKAN.SITE_URL+"/api/3/action/related_"+j,data:h?JSON.stringify(h):undefined,error:function(n,l,m){f("<strong>Error:</strong> Unable to "+j+" related item")}})}var d=b(".related-items");d.find("li").each(function(){var j=b(this),h=j.find(".description");function k(){var m=b(this),l=m.height(),n=m.parent().height(),o=(l-n)/2;if(n<l){m.css("margin-top",-o)}}j.find("img").load(k);h.data("height",h.height()).truncate()});d.on("mouseenter mouseleave",".description.truncated",function(j){var h=j.type==="mouseenter";description=b(this);timer=description.data("hover-intent");function k(){var l=description.parents("li:first"),m=description.data("height")-description.height();description.truncate(h?"expand":"collapse");l.toggleClass("expanded-description",h);l.css("margin-bottom",h?"-="+m+"px":"");description.removeData("hover-intent")}if(!h&&timer){description.removeData("hover-intent");return clearTimeout(timer)}else{if(!h&&!timer){k()}else{description.data("hover-intent",setTimeout(k,200))}}});d.on("click","[data-action=delete]",function(h){var j=b(this).data("relatedId");g("delete","POST",{id:j}).done(function(){b("#related-item-"+j).remove()});h.preventDefault()});b(e).submit(function(j){j.preventDefault();var h=b(this),k={};jQuery.each(h.serializeArray(),function(){k[this.name]=this.value});h.find(".alert").remove();h.find(".error").removeClass("error");if(!k.title){f("<strong>Missing field:</strong> A title is required");b("[name=title]").parent().addClass("error");return}if(!k.url){f("<strong>Missing field:</strong> A url is required");b("[name=url]").parent().addClass("error");return}g("create",this.method,k).done(function(){window.location.reload()})})};c.setupGroupAutocomplete=function(d){d.autocomplete({minLength:2,source:function(f,g){var e=CKAN.SITE_URL+"/api/2/util/group/autocomplete?q="+f.term;b.getJSON(e,function(h){b.each(h,function(j,l){var k=l.name;l.label=k;l.value=l.name});g(h)})}})};c.setupMarkdownEditor=function(d){d.find("button, div.markdown-preview").live("click",function(k){k.preventDefault();var f=b(k.target);var h=f.closest(".markdown-editor");h.find("button").removeClass("depressed");var g=h.find(".markdown-input");var j=h.find(".markdown-preview");if(f.is(".js-markdown-preview")){f.addClass("depressed");raw_markdown=g.val();j.html("<em>"+CKAN.Strings.loading+"<em>");b.post(CKAN.SITE_URL+"/api/util/markdown",{q:raw_markdown},function(e){j.html(e)});j.width(g.width());j.height(g.height());g.hide();j.show()}else{h.find(".js-markdown-edit").addClass("depressed");g.show();j.hide();g.focus()}return false})};c.setupNotesExtract=function(){var e=b("#content div.notes");var f=e.find("#notes-extract > *");if(f.length===0){e.hide()}else{if(f.length>1){var g=e.find("#notes-remainder");b.each(f,function(j,h){if(j>0){g.append(b(h).remove())}});var d=g.height();g.height(0);e.find("#notes-toggle").show();e.find("#notes-toggle button").click(function(h){e.find("#notes-toggle button").toggle();if(b(h.target).hasClass("more")){g.animate({height:d})}else{g.animate({height:0})}return false})}}};c.warnOnFormChanges=function(){var d=false;return function(e){var f=function(){if(d){return}d=true;window.onbeforeunload=function(){return CKAN.Strings.youHaveUnsavedChanges}};e.find("input,select").live("change",function(g){$target=b(g.target);if($target.closest(".resource-add").length===0){f()}});e.submit(function(){window.onbeforeunload=null});return f}}();c.countObject=function(e){var d=0;b.each(e,function(){d++});return d};function a(h){var g=h.currentTarget;if(g.id==="user_follow_button"){var d="user"}else{if(g.id==="dataset_follow_button"){var d="dataset"}else{return}}var l=g.getAttribute("data-obj-id");if(g.getAttribute("data-state")==="follow"){if(d=="user"){var e="/api/action/follow_user"}else{if(d=="dataset"){var e="/api/action/follow_dataset"}else{return}}var j=JSON.stringify({id:l});var f="unfollow";var k=CKAN.Strings.unfollow}else{if(g.getAttribute("data-state")==="unfollow"){if(d=="user"){var e="/api/action/unfollow_user"}else{if(d=="dataset"){var e="/api/action/unfollow_dataset"}else{return}}var j=JSON.stringify({id:l});var f="follow";var k=CKAN.Strings.follow}else{return}}b.ajax({contentType:"application/json",url:e,data:j,dataType:"json",processData:false,type:"POST",success:function(m){g.setAttribute("data-state",f);g.innerHTML=k}})}b("#user_follow_button").on("click",a);b("#dataset_follow_button").on("click",a);return c}(jQuery,CKAN.Utils||{});CKAN.DataPreview=function(a,b){b.jsonpdataproxyUrl="http://jsonpdataproxy.appspot.com/";b.dialogId="ckanext-datapreview";b.$dialog=a("#"+b.dialogId);b.loadEmbeddedPreview=function(g,f){b.$dialog.html('<h4>Loading ... <img src="http://assets.okfn.org/images/icons/ajaxload-circle.gif" class="loading-spinner" /></h4>');var d=_.extend({url:f.url,backend:f.backend},f.dataset);var e=new recline.Model.Dataset(d);var c=null;if(f.currentView==="grid"){c=[{id:"grid",label:"Grid",view:new recline.View.SlickGrid({model:e,state:f["view-grid"]})}]}else{if(f.currentView==="graph"){c=[{id:"graph",label:"Graph",view:new recline.View.Graph({model:e,state:f["view-graph"]})}]}else{if(f.currentView==="map"){c=[{id:"map",label:"Map",view:new recline.View.Map({model:e,state:f["view-map"]})}]}}}var h=new recline.View.MultiView({el:b.$dialog,model:e,state:f,views:c})};b.makeEmbedLink=function(e){var d=e.toJSON();d.state_version=1;var f="?";var c=[];a.each(d,function(g,h){if(typeof(h)==="object"){h=JSON.stringify(h)}c.push(g+"="+escape(h))});f+=c.join("&");return embedPath+f};b.loadPreviewDialog=function(l){b.$dialog.html('<h4>Loading ... <img src="http://assets.okfn.org/images/icons/ajaxload-circle.gif" class="loading-spinner" /></h4>');function g(m){m=m||CKAN.Strings.errorLoadingPreview;return a("#ckanext-datapreview").append("<div></div>").addClass("alert alert-error fade in").html(m)}function h(n){var t=[{id:"grid",label:"Grid",view:new recline.View.SlickGrid({model:n})},{id:"graph",label:"Graph",view:new recline.View.Graph({model:n})},{id:"map",label:"Map",view:new recline.View.Map({model:n})}];var m=new recline.View.MultiView({el:b.$dialog,model:n,views:t,config:{readOnly:true}});a('.menu-right a[data-action="fields"]').click();var s=a(".embedLink");var o=a(".embedIframeText");var r=a(".iframe-width");var q=a(".iframe-height");function u(){var x=b.makeEmbedLink(m.state);var w=r.val();var v=q.val();x+="&width="+w+"&height="+v;o.val(a.mustache('<iframe frameBorder="0" width="{{width}}" height="{{height}}" src="{{link}}"></iframe>',{link:x.replace(/"/g,"&quot;"),width:w,height:v}));s.attr("href",x)}m.state.bind("change",u);for(var p=0;p<m.pageViews.length;p++){m.pageViews[p].view.state.bind("change",u)}r.change(u);q.change(u);u();a(".preview-header .btn").show()}l.formatNormalized=b.normalizeFormat(l.format);l.url=b.normalizeUrl(l.url);if(l.formatNormalized===""){var j=l.url.split("/");j=j[j.length-1];j=j.split("?");j=j[0];var d=j.split(".");if(d.length>1){l.formatNormalized=d[d.length-1]}}recline.Backend.Ckan.API_ENDPOINT=CKAN.SITE_URL+"/api";if(l.datastore_active){l.backend="ckan";var f=new recline.Model.Dataset(l);var k=CKAN.Strings.errorLoadingPreview+": "+CKAN.Strings.errorDataStore;f.fetch().done(function(m){h(m)}).fail(function(m){if(m.message){k+=" ("+m.message+")"}g(k)})}else{if(l.formatNormalized in {csv:"",xls:"",tsv:""}){l.format=l.formatNormalized;l.backend="dataproxy";var f=new recline.Model.Dataset(l);var k=CKAN.Strings.errorLoadingPreview+": "+CKAN.Strings.errorDataProxy;f.fetch().done(function(m){m.bind("query:fail",function(n){a("#ckanext-datapreview .data-view-container").hide();a("#ckanext-datapreview .header").hide();a(".preview-header .btn").hide()});h(m);a(".recline-query-editor .text-query").hide()}).fail(function(m){if(m.message){k+=" ("+m.message+")"}g(k)})}else{if(l.formatNormalized in {"rdf+xml":"","owl+xml":"",xml:"",n3:"","n-triples":"",turtle:"",plain:"",atom:"",tsv:"",rss:"",txt:""}){var e=b.jsonpdataproxyUrl+"?type=csv&url="+l.url;b.getResourceDataDirect(e,function(m){b.showPlainTextData(m)})}else{if(l.formatNormalized in {html:"",htm:""}||l.url.substring(0,23)=="http://docs.google.com/"){b.$dialog.empty();var c=a("<iframe></iframe>");c.attr("src",l.url);c.attr("width","100%");c.attr("height","100%");b.$dialog.append(c)}else{if(l.formatNormalized in {png:"",jpg:"",gif:""}||l.resource_type=="image"){b.$dialog.empty();var c=a("<img />");c.attr("src",l.url);c.css("max-width","100%");c.css("border","solid 4px black");b.$dialog.append(c)}else{b.showError({title:CKAN.Strings.previewNotAvailableForDataType+l.formatNormalized,message:""})}}}}}};b.getResourceDataDirect=function(d,h){var e=5000;var g=setTimeout(function c(){h({error:{title:"Request Error",message:"Dataproxy server did not respond after "+(e/1000)+" seconds"}})},e);var f="_callback";if(d.indexOf("jsonpdataproxy")!=-1){f="callback"}a.ajax({url:d,cache:true,dataType:"jsonp",jsonp:f,success:function(j){clearTimeout(g);h(j)}})};b.showPlainTextData=function(e){if(e.error){b.showError(e.error)}else{var d=a("<pre></pre>");for(var c=0;c<e.data.length;c++){var f=e.data[c].join(",")+"\n";d.append(b.escapeHTML(f))}b.$dialog.html(d)}};b.showError=function(d){var c=_.template('<div class="alert alert-error"><strong><%= title %></strong><br /><%= message %></div>',d);b.$dialog.html(c)};b.normalizeFormat=function(d){var c=d.toLowerCase();c=c.split("/");c=c[c.length-1];return c};b.normalizeUrl=function(c){if(c.indexOf("https")===0){return"http"+c.slice(5)}else{return c}};b.escapeHTML=function(c){return c.replace(/&(?!\w+;|#\d+;|#x[\da-f]+;)/gi,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27").replace(/\//g,"&#x2F;")};a.extend(true,window,{CKANEXT:{}});CKANEXT.DATAPREVIEW=b;return b}(jQuery,CKAN.DataPreview||{});